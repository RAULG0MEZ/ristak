<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test rstk_vid Injection</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 14px;
        }
        iframe {
            width: 100%;
            height: 400px;
            border: 2px solid #ddd;
            border-radius: 4px;
        }
        .link-test {
            display: inline-block;
            margin: 5px;
            padding: 10px 15px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }
        .link-test:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>üß™ Test de Inyecci√≥n rstk_vid</h1>

    <!-- Test 1: URL Actual -->
    <div class="test-section">
        <h2>1Ô∏è‚É£ URL Actual</h2>
        <div id="url-test" class="status info">
            <strong>URL Original:</strong> <code id="original-url"></code><br>
            <strong>URL Despu√©s de 3 segundos:</strong> <code id="updated-url"></code>
        </div>
    </div>

    <!-- Test 2: Links -->
    <div class="test-section">
        <h2>2Ô∏è‚É£ Links de la P√°gina</h2>
        <a href="/otra-pagina" class="link-test">Link Interno</a>
        <a href="https://app.gohighlevel.com/form" class="link-test">Link a GHL</a>
        <a href="https://google.com" class="link-test">Link Externo</a>
        <div id="links-status" class="status info">
            Esperando actualizaci√≥n de links...
        </div>
    </div>

    <!-- Test 3: Formulario Simulado GHL -->
    <div class="test-section">
        <h2>3Ô∏è‚É£ Formulario Tipo GHL</h2>
        <form id="test-form">
            <label>Email:</label><br>
            <input type="email" name="email" placeholder="tu@email.com"><br><br>

            <label>Tel√©fono:</label><br>
            <input type="tel" name="phone" placeholder="+52555555555"><br><br>

            <!-- Campo que GHL usa para capturar desde URL -->
            <label>Campo Hidden que GHL llena desde URL:</label><br>
            <input type="text" name="rstk_vid" placeholder="Se debe llenar autom√°ticamente"
                   style="width: 300px; background: #ffffcc;"><br>
            <small>üëÜ Este campo simula el campo oculto de GHL que captura desde URL</small><br><br>

            <button type="submit">Enviar</button>
        </form>
        <div id="form-status" class="status info">
            Esperando inyecci√≥n en formulario...
        </div>
    </div>

    <!-- Test 4: iframe (GHL embebido) -->
    <div class="test-section">
        <h2>4Ô∏è‚É£ iFrame (Simulaci√≥n GHL Embebido)</h2>
        <iframe src="about:blank" id="test-iframe"></iframe>
        <div id="iframe-status" class="status info">
            Esperando actualizaci√≥n de iframe...
        </div>
    </div>

    <!-- Test 5: localStorage -->
    <div class="test-section">
        <h2>5Ô∏è‚É£ localStorage</h2>
        <div id="storage-status" class="status info">
            Verificando localStorage...
        </div>
    </div>

    <!-- Cargar tracking script -->
    <script defer src="http://localhost:3002/api/tracking/snip.js?s=default"></script>

    <!-- Script de verificaci√≥n -->
    <script>
        // Mostrar URL original
        document.getElementById('original-url').textContent = window.location.href;

        // Funci√≥n para verificar cambios
        function checkChanges() {
            // 1. Verificar URL actual
            const currentUrl = window.location.href;
            document.getElementById('updated-url').textContent = currentUrl;

            if (currentUrl.includes('rstk_vid=')) {
                document.getElementById('url-test').className = 'status success';
                document.getElementById('url-test').innerHTML += '<br><strong>‚úÖ rstk_vid inyectado en URL!</strong>';

                // Extraer el visitor_id
                const urlParams = new URLSearchParams(window.location.search);
                const visitorId = urlParams.get('rstk_vid');
                document.getElementById('url-test').innerHTML += '<br><strong>Visitor ID:</strong> <code>' + visitorId + '</code>';
            }

            // 2. Verificar links
            const links = document.querySelectorAll('a[href]');
            let linksWithRstk = 0;
            links.forEach(link => {
                if (link.href.includes('rstk_vid=')) {
                    linksWithRstk++;
                    link.style.border = '2px solid #28a745';
                }
            });

            if (linksWithRstk > 0) {
                document.getElementById('links-status').className = 'status success';
                document.getElementById('links-status').innerHTML = `‚úÖ ${linksWithRstk} de ${links.length} links actualizados con rstk_vid`;
            }

            // 3. Verificar formulario
            const form = document.getElementById('test-form');
            const hiddenInput = form.querySelector('input[name="rstk_vid"]');

            if (hiddenInput && hiddenInput.value) {
                document.getElementById('form-status').className = 'status success';
                document.getElementById('form-status').innerHTML = `‚úÖ Campo rstk_vid tiene valor: <code>${hiddenInput.value}</code>`;
                hiddenInput.style.background = '#d4edda';
            }

            // 4. Verificar iframe
            const iframe = document.getElementById('test-iframe');
            if (iframe.src && iframe.src.includes('rstk_vid=')) {
                document.getElementById('iframe-status').className = 'status success';
                document.getElementById('iframe-status').innerHTML = `‚úÖ iFrame actualizado con rstk_vid`;
            }

            // 5. Verificar localStorage
            const rstkLocal = localStorage.getItem('rstk_local');
            if (rstkLocal) {
                try {
                    const data = JSON.parse(rstkLocal);
                    document.getElementById('storage-status').className = 'status success';
                    document.getElementById('storage-status').innerHTML = `‚úÖ localStorage contiene:<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
                } catch(e) {
                    document.getElementById('storage-status').className = 'status error';
                    document.getElementById('storage-status').innerHTML = `‚ùå Error parseando localStorage`;
                }
            }
        }

        // Verificar cada 2 segundos
        setInterval(checkChanges, 2000);

        // Verificaci√≥n inicial despu√©s de 1 segundo
        setTimeout(checkChanges, 1000);

        // Interceptar submit del form para ver datos
        document.getElementById('test-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });
            alert('Datos del formulario:\n' + JSON.stringify(data, null, 2));
        });
    </script>
</body>
</html>